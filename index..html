<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>School Success Hub Pro — Modern Minimal</title>

  <!-- Chart.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root{
      --bg: #f6f8fb;
      --card: #ffffff;
      --muted: #6b7280;
      --text: #0f172a;
      --primary: #6366f1;
      --accent: #4f46e5;
      --success: #10b981;
      --danger: #ef4444;
      --radius: 12px;
      --glass: rgba(255,255,255,0.7);
    }
    [data-theme="dark"]{
      --bg: #071026;
      --card: #071126;
      --muted: #94a3b8;
      --text: #e6eef8;
      --primary: #8b5cf6;
      --accent: #7c3aed;
      --glass: rgba(255,255,255,0.02);
    }

    html,body{height:100%;margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial; -webkit-font-smoothing:antialiased;}
    body{background:linear-gradient(180deg,var(--bg), #e9eefb); color:var(--text); padding:18px;}
    .app{max-width:1180px;margin:0 auto;}

    header{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:18px;}
    .brand{display:flex;gap:12px;align-items:center;}
    .logoBox{width:56px;height:56px;border-radius:12px;background:linear-gradient(135deg,var(--primary),var(--accent));display:flex;align-items:center;justify-content:center;color:white;font-weight:700;box-shadow:0 12px 30px rgba(79,70,229,0.12);overflow:hidden;}
    .logoBox img{width:100%;height:100%;object-fit:cover;display:block;}
    h1{margin:0;font-size:1.25rem;}
    .sub{color:var(--muted);font-size:0.95rem;}

    .controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap;}
    .btn{background:var(--card);border:1px solid rgba(15,23,42,0.06);padding:8px 12px;border-radius:10px;cursor:pointer;font-weight:600;}
    .btn.primary{background:linear-gradient(90deg,var(--primary),var(--accent));color:white;border:0;box-shadow:0 8px 24px rgba(79,70,229,0.12);}
    .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);}
    .btn.danger{background:var(--danger);color:white;border:0;}
    .input{padding:8px 10px;border-radius:9px;border:1px solid rgba(15,23,42,0.06);background:transparent;color:var(--text);}

    .layout{display:grid;grid-template-columns:320px 1fr;gap:18px;}
    .card{background:var(--card);border-radius:var(--radius);padding:14px;box-shadow:0 10px 30px rgba(2,6,23,0.06);}

    .side .search{display:flex;gap:8px;margin-bottom:12px;}
    .list{margin-top:8px;max-height:58vh;overflow:auto;padding-right:6px;}
    .student-row{display:flex;align-items:center;justify-content:space-between;gap:8px;padding:10px;border-radius:10px;cursor:pointer;}
    .student-row:hover{background:linear-gradient(120deg,rgba(99,102,241,0.04),transparent);}

    .student-meta{font-size:0.88rem;color:var(--muted);}
    .details{display:flex;gap:12px;flex-direction:column;}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;}
    .stat{background:linear-gradient(180deg,var(--glass),transparent);padding:12px;border-radius:10px;text-align:center;}
    .stat .num{font-weight:800;font-size:1.25rem;}

    .section-title{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;}
    .table{width:100%;border-collapse:collapse;font-size:0.95rem;}
    .table th,.table td{padding:8px;border-bottom:1px solid rgba(15,23,42,0.04);color:var(--muted);}
    .canvas-wrap{background:linear-gradient(180deg,rgba(255,255,255,0.6),transparent);padding:8px;border-radius:10px;}

    .modal-backdrop{position:fixed;inset:0;background:rgba(2,6,23,0.45);display:flex;align-items:center;justify-content:center;z-index:60;}
    .modal{width:720px;max-width:95%;background:var(--card);border-radius:12px;padding:16px;box-shadow:0 20px 60px rgba(2,6,23,0.5);}

    footer{margin-top:20px;text-align:center;color:var(--muted);font-size:0.9rem;}

    @media (max-width:900px){
      .layout{grid-template-columns:1fr;}
      .side{order:2;}
      .main{order:1;}
      header{flex-direction:column;align-items:flex-start;gap:10px;}
    }
  </style>
</head>
<body>
  <div class="app" data-theme="">
    <header>
      <div class="brand">
        <div id="logoBox" class="logoBox" aria-hidden="true"><span id="logoInitials" style="font-size:18px;">SS</span></div>
        <div>
          <h1 id="appTitle">School Success Hub Pro</h1>
          <div id="appSub" class="sub">Modern Minimal • Offline • Installable</div>
        </div>
      </div>

      <div class="controls">
        <input id="search" class="input" placeholder="Search students..." style="width:220px" />
        <select id="gradeFilter" class="input" style="width:150px"><option value="">All grades</option></select>
        <select id="riskFilter" class="input" style="width:150px">
          <option value="">All risk</option><option>Low Risk</option><option>Medium Risk</option><option>High Risk</option>
        </select>

        <select id="sortBy" class="input" style="width:170px"><option value="name">Sort: Name</option><option value="avg_desc">Avg (High→Low)</option><option value="avg_asc">Avg (Low→High)</option><option value="risk_desc">Risk (High→Low)</option></select>

        <button class="btn" id="importBtn">Import</button>
        <button class="btn" id="exportBtn">Export</button>
        <button class="btn primary" id="addNewBtn">+ Add Student</button>
        <button class="btn" id="themeToggle">Theme</button>
      </div>
    </header>

    <div class="layout">
      <aside class="side card">
        <div style="display:flex;gap:8px;align-items:center;margin-bottom:10px;">
          <label class="small">Flagged only</label><input type="checkbox" id="flaggedOnly" />
          <div style="margin-left:auto;display:flex;gap:6px;">
            <button class="btn" id="resetDemo">Reset Demo</button>
            <button class="btn danger" id="clearAll">Clear All</button>
          </div>
        </div>

        <div class="section-title"><strong>Roster</strong><span id="rosterCount" class="small">0</span></div>
        <div class="list" id="rosterList" role="list" aria-label="Students roster"></div>

        <div style="margin-top:14px;">
          <div class="section-title"><strong>Brand & Security</strong></div>
          <label class="small">School name</label>
          <input id="inputSchoolName" class="input" placeholder="Your school name" />
          <label class="small" style="margin-top:8px">Upload Logo (optional)</label>
          <input id="logoFile" type="file" accept="image/*" class="input" />
          <div style="margin-top:8px;display:flex;gap:6px;">
            <button class="btn" id="removeLogoBtn">Remove Logo</button>
            <button class="btn" id="resetLogoBtn">Reset Placeholder</button>
          </div>

          <label class="small" style="margin-top:10px">Set 4-digit PIN (optional)</label>
          <div style="display:flex;gap:8px;margin-top:6px;">
            <input id="pinInput" class="input" placeholder="1234" maxlength="4" style="width:110px"/>
            <button class="btn" id="setPinBtn">Set PIN</button>
            <button class="btn" id="removePinBtn">Remove PIN</button>
          </div>
        </div>
      </aside>

      <main class="main">
        <div class="card details">
          <div class="section-title">
            <div>
              <strong id="selectedName">Select a student</strong>
              <div class="student-meta" id="selectedMeta">Click a student to view scores, add tests, and print reports.</div>
            </div>
            <div class="actions">
              <button class="btn" id="editStudentBtn" style="display:none">Edit</button>
              <button class="btn" id="addScoreBtn" style="display:none">Add Score</button>
              <button class="btn primary" id="printBtn" style="display:none">Print Report</button>
              <button class="btn" id="copyLinkBtn" style="display:none">Copy Report Link</button>
              <button class="btn danger" id="deleteStudentBtn" style="display:none">Delete</button>
            </div>
          </div>

          <div class="grid">
            <div class="stat"><div class="small">Average Score</div><div class="num" id="avgScore">—</div></div>
            <div class="stat"><div class="small">Last Score</div><div class="num" id="lastScore">—</div></div>
            <div class="stat"><div class="small">Risk Level</div><div class="num" id="riskLevel">—</div></div>
            <div class="stat"><div class="small">Total Tests</div><div class="num" id="testCount">—</div></div>
          </div>

          <div style="margin-top:12px;">
            <div class="section-title"><strong>Performance Chart</strong></div>
            <div class="canvas-wrap"><canvas id="mainChart" height="160"></canvas></div>
          </div>

          <div style="margin-top:12px;">
            <div class="section-title"><strong>Score History</strong></div>
            <table class="table" id="scoresTable"><thead><tr><th>Date</th><th>Score</th><th>Note</th></tr></thead><tbody></tbody></table>
          </div>
        </div>

        <div style="height:12px"></div>

        <div class="card">
          <div class="section-title"><strong>Class Insights</strong></div>
          <div class="grid">
            <div class="stat"><div class="small">Class Avg Score</div><div class="num" id="insClassAvg">—</div></div>
            <div class="stat"><div class="small">Flagged Students</div><div class="num" id="insFlagged">—</div></div>
            <div class="stat"><div class="small">Total Students</div><div class="num" id="insTotal">—</div></div>
            <div class="stat"><div class="small">Export Reports</div><div style="margin-top:8px"><button class="btn" id="exportAllReports">Export All Reports</button></div></div>
          </div>
        </div>
      </main>
    </div>

    <footer>School Success Hub Pro • Modern Minimal • Offline • Installable</footer>
  </div>

  <input type="file" id="fileInput" accept="application/json" style="display:none" />

  <!-- Templates -->
  <template id="studentFormTpl">
    <div class="modal-backdrop" id="modalRoot"><div class="modal">
      <h3 id="modalTitle">Add student</h3>
      <div style="margin-top:8px"><label>Full name</label><input id="m_name" class="input" /></div>
      <div style="margin-top:8px"><label>Grade</label><select id="m_grade" class="input"></select></div>
      <div style="margin-top:8px"><label>Initial score (0–100)</label><input id="m_score" class="input" type="number" min="0" max="100" /></div>
      <div style="margin-top:8px"><label>Attendance (%)</label><input id="m_att" class="input" type="number" min="0" max="100" value="95" /></div>
      <div style="margin-top:12px;display:flex;gap:8px;justify-content:flex-end"><button id="m_cancel" class="btn">Cancel</button><button id="m_save" class="btn primary">Save</button></div>
    </div></div>
  </template>

  <template id="scoreFormTpl">
    <div class="modal-backdrop" id="modalRoot"><div class="modal">
      <h3>Add score</h3>
      <div style="margin-top:8px"><label>Score (0–100)</label><input id="s_score" class="input" type="number" min="0" max="100" /></div>
      <div style="margin-top:8px"><label>Note</label><input id="s_note" class="input" placeholder="Optional note" /></div>
      <div style="margin-top:12px;display:flex;gap:8px;justify-content:flex-end"><button id="s_cancel" class="btn">Cancel</button><button id="s_save" class="btn primary">Add</button></div>
    </div></div>
  </template>

  <template id="pinModalTpl">
    <div class="modal-backdrop" id="modalRoot"><div class="modal">
      <h3>Enter PIN</h3>
      <p class="small">This app is protected by a local 4-digit PIN. Enter it to continue.</p>
      <div style="margin-top:8px"><input id="pin_entry" class="input" placeholder="1234" maxlength="4" /></div>
      <div style="margin-top:12px;display:flex;gap:8px;justify-content:flex-end"><button id="pin_cancel" class="btn">Exit</button><button id="pin_submit" class="btn primary">Unlock</button></div>
    </div></div>
  </template>

  <script>
  (async function(){
    // STORAGE KEY
    const STORAGE_KEY = 'sshp_pro_v1';

    // DOM refs
    const appRoot = document.querySelector('.app');
    const rosterList = document.getElementById('rosterList');
    const rosterCount = document.getElementById('rosterCount');
    const searchInput = document.getElementById('search');
    const gradeFilter = document.getElementById('gradeFilter');
    const riskFilter = document.getElementById('riskFilter');
    const sortBy = document.getElementById('sortBy');
    const flaggedOnly = document.getElementById('flaggedOnly');
    const addNewBtn = document.getElementById('addNewBtn');
    const importBtn = document.getElementById('importBtn');
    const exportBtn = document.getElementById('exportBtn');
    const fileInput = document.getElementById('fileInput');
    const logoFile = document.getElementById('logoFile');
    const removeLogoBtn = document.getElementById('removeLogoBtn');
    const resetLogoBtn = document.getElementById('resetLogoBtn');
    const inputSchoolName = document.getElementById('inputSchoolName');
    const inputLogo = document.getElementById('inputLogo'); // not visible in UI, kept for compatibility
    const themeToggle = document.getElementById('themeToggle');
    const setPinBtn = document.getElementById('setPinBtn');
    const removePinBtn = document.getElementById('removePinBtn');
    const pinInput = document.getElementById('pinInput');
    const resetDemo = document.getElementById('resetDemo');
    const clearAllBtn = document.getElementById('clearAll');
    const editStudentBtn = document.getElementById('editStudentBtn');
    const addScoreBtn = document.getElementById('addScoreBtn');
    const printBtn = document.getElementById('printBtn');
    const copyLinkBtn = document.getElementById('copyLinkBtn');
    const deleteStudentBtn = document.getElementById('deleteStudentBtn');
    const mainChartCtx = document.getElementById('mainChart').getContext('2d');
    const scoresTableBody = document.querySelector('#scoresTable tbody');
    const avgScoreEl = document.getElementById('avgScore');
    const lastScoreEl = document.getElementById('lastScore');
    const riskLevelEl = document.getElementById('riskLevel');
    const testCountEl = document.getElementById('testCount');
    const insClassAvg = document.getElementById('insClassAvg');
    const insFlagged = document.getElementById('insFlagged');
    const insTotal = document.getElementById('insTotal');
    const exportAllReports = document.getElementById('exportAllReports');
    const logoBox = document.getElementById('logoBox');
    const logoInitials = document.getElementById('logoInitials');
    const appTitle = document.getElementById('appTitle');

    // state
    let state = { students: [], selectedId: null, theme: 'light', school: { name: 'School Success Hub Pro', logoInitials: 'SS', logoData: null }, pinHash: null };
    let mainChart = null;

    // helpers
    function genId(){ return Date.now().toString(36) + '-' + Math.random().toString(36).slice(2,9); }
    function clamp(v,a=0,b=100){ return Math.max(a, Math.min(b, v)); }
    function avg(arr){ if(!arr || arr.length===0) return 0; return arr.reduce((a,b)=>a+b,0)/arr.length; }
    function nowISO(){ return new Date().toISOString(); }
    function escapeHtml(str){ if(!str && str!==0) return ''; return String(str).replace(/[&<>"']/g, s=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' })[s]); }

    // crypto: sha256 hex
    async function sha256hex(msg){
      const enc = new TextEncoder().encode(msg);
      const buf = await crypto.subtle.digest('SHA-256', enc);
      return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');
    }

    // persistence
    function saveState(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }
    function loadState(){ try{ const raw = localStorage.getItem(STORAGE_KEY); return raw ? JSON.parse(raw) : null } catch(e){ return null } }

    // demo data
    function demoData(){
      const now = nowISO();
      return [
        { id: genId(), name:'Aisha Khan', grade:'Grade 5', scores:[72,75,78], scoreDates:[now,now,now], scoreNotes:['','Improved',''], notes:[], attendance:98 },
        { id: genId(), name:'Bilal Ahmed', grade:'Grade 5', scores:[55,58,60], scoreDates:[now,now,now], scoreNotes:['Needs fractions','Practice fractions',''], notes:['Struggling with fractions'], attendance:88 },
        { id: genId(), name:'Fatima Noor', grade:'Grade 4', scores:[91,93], scoreDates:[now,now], scoreNotes:['','Great'], notes:[], attendance:100 }
      ];
    }

    // risk
    function computeRiskFromScore(score){
      score = Number(score) || 0;
      if(score < 50) return 'High Risk';
      if(score < 75) return 'Medium Risk';
      return 'Low Risk';
    }
    function computeRisk(student){
      const latest = student.scores && student.scores.length ? student.scores[student.scores.length-1] : avg(student.scores||[]);
      let r = computeRiskFromScore(latest);
      if(student.attendance < 90){
        if(r === 'Low Risk') r = 'Medium Risk';
        else if(r === 'Medium Risk') r = 'High Risk';
      }
      if((student.notes||[]).some(n => /struggl|behind|needs/i.test(n))){
        if(r === 'Low Risk') r = 'Medium Risk';
      }
      return r;
    }

    // init
    function init(){
      const saved = loadState();
      if(saved && saved.students && saved.students.length){
        state = saved;
      } else {
        state.students = demoData();
        state.theme = 'light';
        state.school = { name: 'School Success Hub Pro', logoInitials: 'SS', logoData: null };
        state.pinHash = null;
        state.selectedId = state.students[0]?.id || null;
        saveState();
      }
      applyTheme();
      populateSettings();
      populateGradeFilter();
      renderRoster();
      selectInitial();
      attachListeners();
      registerPWA();
      updateInsights();
    }

    function applyTheme(){
      document.querySelector('.app').setAttribute('data-theme', state.theme === 'dark' ? 'dark' : '');
      themeToggle.textContent = state.theme === 'dark' ? 'Light' : 'Dark';
    }

    function populateSettings(){
      document.getElementById('inputSchoolName').value = state.school.name || '';
      logoInitials.textContent = (state.school.logoInitials || 'SS').slice(0,2).toUpperCase();
      appTitle.textContent = state.school.name || 'School Success Hub Pro';
      // show logo data if present
      if(state.school.logoData){
        logoBox.innerHTML = `<img src="${state.school.logoData}" alt="logo" />`;
      } else {
        logoBox.innerHTML = `<div style="display:flex;align-items:center;justify-content:center;width:100%;height:100%;"><span style="font-weight:700;color:white">${escapeHtml(state.school.logoInitials || 'SS')}</span></div>`;
      }
    }

    function populateGradeFilter(){
      const grades = Array.from(new Set(state.students.map(s=>s.grade))).sort();
      gradeFilter.innerHTML = `<option value="">All grades</option>` + grades.map(g=>`<option value="${g}">${g}</option>`).join('');
    }

    // roster
    function renderRoster(){
      rosterList.innerHTML = '';
      let list = [...state.students];
      const q = (searchInput.value||'').trim().toLowerCase();
      if(q) list = list.filter(s => s.name.toLowerCase().includes(q) || (s.notes||[]).join(' ').toLowerCase().includes(q));
      const gf = gradeFilter.value; if(gf) list = list.filter(s => s.grade === gf);
      const rf = riskFilter.value; if(rf) list = list.filter(s => computeRisk(s) === rf);
      if(flaggedOnly.checked) list = list.filter(s => computeRisk(s) !== 'Low Risk');

      // sorting
      const sort = sortBy.value;
      if(sort === 'name') list.sort((a,b)=> a.name.localeCompare(b.name));
      else if(sort === 'avg_desc') list.sort((a,b)=> avg(b.scores||[]) - avg(a.scores||[]));
      else if(sort === 'avg_asc') list.sort((a,b)=> avg(a.scores||[]) - avg(b.scores||[]));
      else if(sort === 'risk_desc') list.sort((a,b)=> ({'High Risk':3,'Medium Risk':2,'Low Risk':1}[computeRisk(b)]||0) - ({'High Risk':3,'Medium Risk':2,'Low Risk':1}[computeRisk(a)]||0));

      for(const s of list){
        const row = document.createElement('div');
        row.className = 'student-row';
        row.title = `Select ${s.name}`;
        row.innerHTML = `<div><strong>${escapeHtml(s.name)}</strong><div class="student-meta">${escapeHtml(s.grade)} • avg ${avg(s.scores||[]).toFixed(1)}%</div></div><div style="text-align:right"><small style="color:var(--muted)">${computeRisk(s)}</small><div style="font-weight:700">${(s.scores||[]).length} tests</div></div>`;
        row.addEventListener('click', ()=> selectStudent(s.id));
        rosterList.appendChild(row);
      }
      rosterCount.textContent = list.length;
    }

    function selectInitial(){
      if(state.selectedId && state.students.find(s=>s.id===state.selectedId)) selectStudent(state.selectedId);
      else if(state.students.length) selectStudent(state.students[0].id);
      else clearSelection();
    }

    function selectStudent(id){
      state.selectedId = id; saveState();
      const s = state.students.find(x=>x.id===id);
      if(!s) return clearSelection();
      document.getElementById('selectedName').textContent = s.name;
      document.getElementById('selectedMeta').textContent = `${s.grade} • Attendance: ${s.attendance ?? '—'}%`;
      avgScoreEl.textContent = (avg(s.scores||[])||0).toFixed(1) + '%';
      lastScoreEl.textContent = (s.scores && s.scores.length ? s.scores[s.scores.length-1] + '%' : '—');
      riskLevelEl.textContent = computeRisk(s);
      testCountEl.textContent = (s.scores||[]).length;
      document.getElementById('editStudentBtn').style.display = '';
      document.getElementById('addScoreBtn').style.display = '';
      document.getElementById('printBtn').style.display = '';
      document.getElementById('copyLinkBtn').style.display = '';
      document.getElementById('deleteStudentBtn').style.display = '';
      renderScoresTable(s);
      renderMainChart(s);
    }

    function clearSelection(){
      state.selectedId = null; saveState();
      document.getElementById('selectedName').textContent = 'Select a student';
      document.getElementById('selectedMeta').textContent = 'Click a student to view scores, add tests, and print reports.';
      avgScoreEl.textContent = '—'; lastScoreEl.textContent = '—'; riskLevelEl.textContent = '—'; testCountEl.textContent = '—';
      document.getElementById('editStudentBtn').style.display = 'none';
      document.getElementById('addScoreBtn').style.display = 'none';
      document.getElementById('printBtn').style.display = 'none';
      document.getElementById('copyLinkBtn').style.display = 'none';
      document.getElementById('deleteStudentBtn').style.display = 'none';
      scoresTableBody.innerHTML = '';
      if(mainChart){ mainChart.destroy(); mainChart = null; }
    }

    function renderScoresTable(student){
      scoresTableBody.innerHTML = '';
      const rows = (student.scores||[]).map((score, idx) => {
        const date = student.scoreDates && student.scoreDates[idx] ? new Date(student.scoreDates[idx]) : new Date();
        const note = student.scoreNotes && student.scoreNotes[idx] ? student.scoreNotes[idx] : '';
        return {date, score, note};
      }).reverse();
      for(const r of rows){
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${r.date.toLocaleString()}</td><td><strong>${r.score}%</strong></td><td>${escapeHtml(r.note||'')}</td>`;
        scoresTableBody.appendChild(tr);
      }
    }

    function renderMainChart(student){
      if(mainChart) mainChart.destroy();
      const labels = (student.scoreDates || student.scores || []).map((d,i)=> student.scoreDates && student.scoreDates[i] ? new Date(student.scoreDates[i]).toLocaleDateString() : `Test ${i+1}`);
      const data = student.scores || [];
      mainChart = new Chart(mainChartCtx, {
        type:'line',
        data:{ labels, datasets:[{ label:'Score', data, fill:true, tension:0.3, borderWidth:2, borderColor:getComputedStyle(document.documentElement).getPropertyValue('--primary').trim() || '#6366f1', backgroundColor:'rgba(99,102,241,0.08)', pointRadius:4 }]},
        options:{ scales:{ y:{ beginAtZero:true, max:100 } }, plugins:{ legend:{ display:false } }, maintainAspectRatio:false }
      });
    }

    // modals
    function openStudentModal(existing){
      const tpl = document.getElementById('studentFormTpl');
      const node = tpl.content.cloneNode(true);
      document.body.appendChild(node);
      const modalRoot = document.getElementById('modalRoot');
      const m_title = modalRoot.querySelector('#modalTitle');
      const m_name = modalRoot.querySelector('#m_name');
      const m_grade = modalRoot.querySelector('#m_grade');
      const m_score = modalRoot.querySelector('#m_score');
      const m_att = modalRoot.querySelector('#m_att');
      const m_cancel = modalRoot.querySelector('#m_cancel');
      const m_save = modalRoot.querySelector('#m_save');

      m_grade.innerHTML = ['Grade 1','Grade 2','Grade 3','Grade 4','Grade 5','Grade 6'].map(g=>`<option value="${g}">${g}</option>`).join('');

      if(existing){ m_title.textContent = 'Edit student'; m_name.value = existing.name; m_grade.value = existing.grade; m_score.value = existing.scores && existing.scores[0] ? existing.scores[0] : ''; m_att.value = existing.attendance || 95; }
      else { m_title.textContent = 'Add student'; m_att.value = 95; }

      m_cancel.addEventListener('click', ()=> modalRoot.remove());
      modalRoot.addEventListener('click', (e)=> { if(e.target === modalRoot) modalRoot.remove(); });

      m_save.addEventListener('click', ()=>{
        const name = m_name.value.trim(); const grade = m_grade.value; const initScore = m_score.value ? clamp(Number(m_score.value)) : null; const attendance = m_att.value ? clamp(Number(m_att.value),0,100) : 95;
        if(!name) return alert('Enter name');
        if(existing){
          existing.name = name; existing.grade = grade; existing.attendance = attendance;
          if(initScore !== null && !isNaN(initScore) && (!existing.scores || existing.scores.length===0)){
            existing.scores = [initScore]; existing.scoreDates = [nowISO()]; existing.scoreNotes = ['Initial'];
          }
        } else {
          const s = { id: genId(), name, grade, scores: initScore !== null ? [initScore] : [], scoreDates: initScore !== null ? [nowISO()] : [], scoreNotes: initScore !== null ? ['Initial'] : [], notes:[], attendance };
          state.students.push(s); state.selectedId = s.id;
        }
        populateGradeFilter(); saveState(); renderRoster(); selectStudent(state.selectedId); modalRoot.remove(); updateInsights();
      });
    }

    function openScoreModal(student){
      const tpl = document.getElementById('scoreFormTpl');
      const node = tpl.content.cloneNode(true);
      document.body.appendChild(node);
      const modalRoot = document.getElementById('modalRoot');
      const s_score = modalRoot.querySelector('#s_score');
      const s_note = modalRoot.querySelector('#s_note');
      const s_cancel = modalRoot.querySelector('#s_cancel');
      const s_save = modalRoot.querySelector('#s_save');

      s_cancel.addEventListener('click', ()=> modalRoot.remove());
      modalRoot.addEventListener('click', (e)=> { if(e.target === modalRoot) modalRoot.remove(); });

      s_save.addEventListener('click', ()=> {
        const score = clamp(Number(s_score.value || 0)); const note = s_note.value.trim();
        if(isNaN(score)) return alert('Enter a score');
        student.scores = student.scores || []; student.scoreDates = student.scoreDates || []; student.scoreNotes = student.scoreNotes || [];
        student.scores.push(score); student.scoreDates.push(nowISO()); student.scoreNotes.push(note);
        saveState(); renderRoster(); selectStudent(student.id); modalRoot.remove(); updateInsights();
      });
    }

    // printing (include chart image)
    async function printStudentReport(student){
      if(!student) return;
      let chartDataUrl = '';
      try { chartDataUrl = document.getElementById('mainChart').toDataURL('image/png'); } catch(e){}
      const avgScore = (avg(student.scores||[])||0).toFixed(1);
      const scoresList = (student.scores||[]).map((sc,i)=> `<li>Test ${i+1}: ${sc}% ${student.scoreDates && student.scoreDates[i] ? '(' + new Date(student.scoreDates[i]).toLocaleDateString() + ')' : ''}${student.scoreNotes && student.scoreNotes[i] ? ' — ' + escapeHtml(student.scoreNotes[i]) : ''}</li>`).join('');
      const w = window.open('','_blank','noopener');
      const html = `<!doctype html><html><head><meta charset="utf-8"><title>Report - ${escapeHtml(student.name)}</title><style>body{font-family:Inter,Arial;padding:20px;color:#111}h1{color:${getComputedStyle(document.documentElement).getPropertyValue('--primary').trim() || '#6366f1'}}</style></head><body><h1>${escapeHtml(state.school.name)} — Student Report</h1><p><strong>Name:</strong> ${escapeHtml(student.name)}<br><strong>Grade:</strong> ${escapeHtml(student.grade)}<br><strong>Average:</strong> ${avgScore}%<br><strong>Risk:</strong> ${computeRisk(student)}</p><h3>Scores</h3><ul>${scoresList}</ul>${chartDataUrl?'<h3>Chart</h3><img src="'+chartDataUrl+'" alt="chart" style="max-width:100%"/>':''}<p style="color:#666">Generated: ${new Date().toLocaleString()}</p><script>window.onload=()=>setTimeout(()=>window.print(),300)</script></body></html>`;
      w.document.write(html); w.document.close();
    }

    // copy report link (embed small payload in hash)
    function copyReportLink(student){
      try{
        const payload = { s: student, school: state.school, v:1 };
        const encoded = btoa(unescape(encodeURIComponent(JSON.stringify(payload))));
        const url = location.origin + location.pathname + '#report=' + encoded;
        navigator.clipboard.writeText(url).then(()=> alert('Report link copied to clipboard.'));
      }catch(e){ alert('Could not copy link.'); }
    }

    // export all reports (print)
    function exportAllReports(){
      const parts = state.students.map(student=>{
        const avgScore = (avg(student.scores||[])||0).toFixed(1);
        const scoresList = (student.scores||[]).map((sc,i)=> `<li>Test ${i+1}: ${sc}% ${student.scoreDates && student.scoreDates[i] ? '(' + new Date(student.scoreDates[i]).toLocaleDateString()+')' : ''}${student.scoreNotes && student.scoreNotes[i] ? ' — '+escapeHtml(student.scoreNotes[i]) : ''}</li>`).join('');
        return `<section style="page-break-inside:avoid;margin-bottom:20px"><h2>${escapeHtml(student.name)}</h2><div><strong>Grade:</strong> ${escapeHtml(student.grade)} • <strong>Avg:</strong> ${avgScore}% • <strong>Risk:</strong> ${computeRisk(student)}</div><h3>Scores</h3><ul>${scoresList}</ul></section>`;
      }).join('');
      const w = window.open('','_blank');
      const html = `<!doctype html><html><head><meta charset="utf-8"><title>All Reports</title><style>body{font-family:Inter,Arial;padding:20px;color:#111}h1{color:${getComputedStyle(document.documentElement).getPropertyValue('--primary').trim() || '#6366f1'}}</style></head><body><h1>${escapeHtml(state.school.name)} — All Student Reports</h1>${parts}<script>window.onload=()=>setTimeout(()=>window.print(),300)</script></body></html>`;
      w.document.write(html); w.document.close();
    }

    // export import JSON
    function exportJSON(){
      const payload = { meta:{ exportedAt: nowISO(), version: 3 }, students: state.students, school: state.school, theme: state.theme };
      const blob = new Blob([JSON.stringify(payload, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = `sshp-backup-${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.json`; a.click(); URL.revokeObjectURL(url);
    }

    function importJSONFile(file){
      const reader = new FileReader();
      reader.onload = e => {
        try{
          const data = JSON.parse(e.target.result);
          if(!data.students) throw new Error('Invalid backup file');
          state.students = data.students.map(s => ({
            id: s.id || genId(),
            name: s.name || 'Unknown',
            grade: s.grade || 'Grade 1',
            scores: s.scores || [],
            scoreDates: s.scoreDates || (s.scores ? s.scores.map(()=>nowISO()) : []),
            scoreNotes: s.scoreNotes || [],
            notes: s.notes || [],
            attendance: s.attendance || 95
          }));
          state.school = data.school || state.school;
          state.theme = data.theme || state.theme;
          state.selectedId = state.students[0]?.id || null;
          saveState(); populateSettings(); populateGradeFilter(); renderRoster(); selectInitial(); updateInsights();
          alert('Import successful.');
        }catch(err){ alert('Import failed: ' + err.message); }
      };
      reader.readAsText(file);
    }

    // set/remove PIN
    async function setPin(pin){
      if(!/^\d{4}$/.test(pin)) return alert('PIN must be 4 digits.');
      state.pinHash = await sha256hex(pin);
      saveState();
      alert('PIN saved locally.');
    }
    function removePin(){
      state.pinHash = null; saveState(); alert('PIN removed.');
    }
    // request PIN unlock if set
    async function requestPinUnlock(){
      if(!state.pinHash) return true;
      const tpl = document.getElementById('pinModalTpl');
      const node = tpl.content.cloneNode(true);
      document.body.appendChild(node);
      const modalRoot = document.getElementById('modalRoot');
      const entry = modalRoot.querySelector('#pin_entry');
      const cancel = modalRoot.querySelector('#pin_cancel');
      const submit = modalRoot.querySelector('#pin_submit');
      return new Promise((resolve)=>{
        cancel.addEventListener('click', ()=> { modalRoot.remove(); resolve(false); });
        modalRoot.addEventListener('click', (e)=> { if(e.target===modalRoot){ modalRoot.remove(); resolve(false); } });
        submit.addEventListener('click', async ()=> {
          const val = entry.value.trim();
          if(!/^\d{4}$/.test(val)) return alert('Enter 4 digits');
          const h = await sha256hex(val);
          if(h === state.pinHash){ modalRoot.remove(); resolve(true); } else { alert('Incorrect PIN'); }
        });
      });
    }

    // logo upload
    function handleLogoUpload(file){
      if(!file) return;
      const reader = new FileReader();
      reader.onload = e => {
        state.school.logoData = e.target.result;
        state.school.logoInitials = null;
        saveState();
        populateSettings();
        registerPWA();
      };
      reader.readAsDataURL(file);
    }

    // remove logo
    function removeLogo(){ state.school.logoData = null; state.school.logoInitials = (state.school.logoInitials || 'SS').slice(0,2).toUpperCase(); saveState(); populateSettings(); registerPWA(); }

    // events
    function attachListeners(){
      addNewBtn.addEventListener('click', async ()=> { const ok = await requestPinUnlock(); if(ok) openStudentModal(null); else alert('PIN required.'); });
      importBtn.addEventListener('click', ()=> fileInput.click());
      fileInput.addEventListener('change', ()=> { const f = fileInput.files[0]; if(f) importJSONFile(f); fileInput.value = ''; });
      exportBtn.addEventListener('click', exportJSON);
      logoFile.addEventListener('change', ()=> { const f = logoFile.files[0]; if(f) handleLogoUpload(f); logoFile.value = ''; });
      removeLogoBtn.addEventListener('click', ()=> { if(confirm('Remove uploaded logo?')) removeLogo(); });
      resetLogoBtn.addEventListener('click', ()=> { if(confirm('Reset to placeholder initials?')) { state.school.logoData = null; state.school.logoInitials = (state.school.name||'SS').split(' ').map(w=>w[0]).slice(0,2).join('').toUpperCase(); saveState(); populateSettings(); registerPWA(); } });
      inputSchoolName.addEventListener('change', ()=> { state.school.name = inputSchoolName.value.trim() || 'School Success Hub Pro'; saveState(); populateSettings(); registerPWA(); });
      setPinBtn.addEventListener('click', async ()=> { const v = pinInput.value.trim(); if(!/^\d{4}$/.test(v)) return alert('Enter 4 digits'); await setPin(v); pinInput.value = ''; });
      removePinBtn.addEventListener('click', ()=> { if(confirm('Remove PIN?')) removePin(); });
      searchInput.addEventListener('input', renderRoster);
      gradeFilter.addEventListener('change', renderRoster);
      riskFilter.addEventListener('change', renderRoster);
      sortBy.addEventListener('change', renderRoster);
      flaggedOnly.addEventListener('change', renderRoster);
      resetDemo.addEventListener('click', ()=> { if(confirm('Replace data with demo dataset?')) { state.students = demoData(); saveState(); populateGradeFilter(); renderRoster(); selectInitial(); updateInsights(); } });
      clearAllBtn.addEventListener('click', ()=> { if(confirm('Clear all data? This cannot be undone.')) { state.students = []; state.selectedId = null; saveState(); renderRoster(); clearSelection(); updateInsights(); } });
      document.getElementById('editStudentBtn').addEventListener('click', ()=> { const s = state.students.find(x=>x.id===state.selectedId); if(s) openStudentModal(s); });
      document.getElementById('addScoreBtn').addEventListener('click', ()=> { const s = state.students.find(x=>x.id===state.selectedId); if(s) openScoreModal(s); });
      document.getElementById('printBtn').addEventListener('click', ()=> { const s = state.students.find(x=>x.id===state.selectedId); if(s) printStudentReport(s); });
      document.getElementById('copyLinkBtn').addEventListener('click', ()=> { const s = state.students.find(x=>x.id===state.selectedId); if(s) copyReportLink(s); });
      document.getElementById('deleteStudentBtn').addEventListener('click', ()=> { if(!confirm('Delete student?')) return; state.students = state.students.filter(s=>s.id!==state.selectedId); saveState(); renderRoster(); selectInitial(); updateInsights(); });
      exportAllReports.addEventListener('click', exportAllReports);
      themeToggle.addEventListener('click', ()=> { state.theme = state.theme === 'dark' ? 'light' : 'dark'; applyTheme(); saveState(); });

      // keyboard: N = new student
      document.addEventListener('keydown', (e)=> { if(e.key === 'n' && !e.ctrlKey && !e.metaKey) { openStudentModal(null); } });

      // drag & drop import
      window.addEventListener('dragover', e => e.preventDefault());
      window.addEventListener('drop', e => { e.preventDefault(); const f = e.dataTransfer.files[0]; if(f && f.type === 'application/json') importJSONFile(f); });

      // logo upload via input done earlier
    }

    // PWA register (manifest + sw via blobs)
    function registerPWA(){
      if(!('serviceWorker' in navigator)) return;
      const manifest = { name: state.school.name || 'School Success Hub Pro', short_name: 'SSH Pro', start_url: location.pathname, display: 'standalone', background_color: '#ffffff', icons: [] };
      // create a small svg data url for icon using initials or uploaded logo
      if(state.school.logoData){
        manifest.icons.push({ src: state.school.logoData, sizes: '192x192', type: 'image/png' });
      } else {
        const initials = (state.school.logoInitials || (state.school.name || 'SS')).slice(0,2).toUpperCase();
        const svg = `<svg xmlns='http://www.w3.org/2000/svg' width='192' height='192'><rect width='100%' height='100%' fill='${encodeURIComponent('#4f46e5')}' /><text x='50%' y='55%' font-size='64' fill='white' text-anchor='middle' font-family='Arial'>${initials}</text></svg>`;
        const svgUrl = 'data:image/svg+xml;utf8,' + encodeURIComponent(svg);
        manifest.icons.push({ src: svgUrl, sizes: '192x192', type: 'image/svg+xml' });
      }
      const blob = new Blob([JSON.stringify(manifest)], { type: 'application/json' });
      const manifestUrl = URL.createObjectURL(blob);
      let link = document.querySelector('link[rel="manifest"]');
      if(link) link.href = manifestUrl; else { link = document.createElement('link'); link.rel = 'manifest'; link.href = manifestUrl; document.head.appendChild(link); }

      // service worker code
      const swCode = `
        const CACHE = 'sshp-cache-v1';
        const toCache = ['./'];
        self.addEventListener('install', e => { self.skipWaiting(); e.waitUntil(caches.open(CACHE).then(c=>c.addAll(toCache))); });
        self.addEventListener('activate', e => { e.waitUntil(self.clients.claim()); });
        self.addEventListener('fetch', e => { e.respondWith(caches.match(e.request).then(r => r || fetch(e.request).catch(()=>caches.match('./')))); });
      `;
      const swBlob = new Blob([swCode], { type: 'application/javascript' });
      const swUrl = URL.createObjectURL(swBlob);
      navigator.serviceWorker.register(swUrl).catch(()=>{/* may fail on file:// */});
    }

    // update insights
    function updateInsights(){
      const total = state.students.length;
      insTotal.textContent = total;
      insClassAvg.textContent = total ? (avg(state.students.map(s=>avg(s.scores||[])))||0).toFixed(1) + '%' : '—';
      insFlagged.textContent = state.students.filter(s => computeRisk(s) !== 'Low Risk').length;
    }

    // initialize
    init();
    attachListeners();

    // expose basic API for debugging
    window.SSHP = { state, saveState, renderRoster, selectStudent };

  })();
  </script>
</body>
</html>
